<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Opname V3 (Fix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('stockApp', () => ({
                items: [],
                searchQuery: '',
                showCalc: false,
                calcDisplay: '',

                init() {
                    console.log("Aplikasi Siap");
                },

                get filteredItems() {
                    if (this.searchQuery === '') return this.items;
                    return this.items.filter(i => i.name.toLowerCase().includes(this.searchQuery.toLowerCase()));
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.SheetNames[0];
                            const json = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
                            
                            // Ambil data mulai baris ke-2 (index 1), baris 1 dianggap Header
                            this.items = json.slice(1).map((row, i) => ({
                                id: Date.now() + i,     // ID Unik
                                name: row[0] || 'Tanpa Nama',
                                rak: '', m1: '', m2: '', m3: '', m4: ''
                            })).filter(i => i.name !== 'Tanpa Nama'); // Hapus baris kosong
                            
                            // Reset input file agar bisa upload ulang
                            e.target.value = '';
                        } catch (err) {
                            alert("Gagal baca file. Pastikan format .xlsx");
                            console.error(err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },

                calculateTotal(item) {
                    return (Number(item.rak)||0) + (Number(item.m1)||0) + (Number(item.m2)||0) + (Number(item.m3)||0) + (Number(item.m4)||0);
                },

                copyTotals() {
                    // Hanya copy data yang tampil (ter-filter) atau semua jika tidak search
                    const dataTarget = this.searchQuery ? this.filteredItems : this.items;
                    
                    if(dataTarget.length === 0) {
                        alert("Tidak ada data untuk disalin!");
                        return;
                    }

                    const totals = dataTarget.map(i => this.calculateTotal(i)).join('\n');
                    
                    // Cara Copy paling aman untuk semua browser HP
                    const textArea = document.createElement("textarea");
                    textArea.value = totals;
                    textArea.style.position = "fixed"; // Hindari scroll ke bawah
                    textArea.style.opacity = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        alert(`✅ Berhasil menyalin ${dataTarget.length} baris!`);
                    } catch (err) {
                        alert('❌ Gagal menyalin otomatis.');
                    }
                    document.body.removeChild(textArea);
                },

                resetApp() {
                    if(confirm("Hapus semua data dan mulai baru?")) {
                        this.items = [];
                        this.searchQuery = '';
                    }
                },

                // Logic Kalkulator
                calcAppend(v) { this.
